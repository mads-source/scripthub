_G.ESP = {
	Characters = {},
	Color = Color3.fromRGB(255, 255, 255),
}
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local Folder = Instance.new("Folder")
Folder.Name = string.gsub(HttpService:GenerateGUID(false), "-", ""):upper()
Folder.Parent = game:GetService("CoreGui")
local function CreateSelectionBox(Bodypart)
	local SelectionBox = Instance.new("SelectionBox")
	SelectionBox.Adornee = Bodypart
	SelectionBox.Name = Bodypart.Name.."-SelectionBox"
	SelectionBox.Color3 = _G.ESP.Color
	SelectionBox.SurfaceColor3 = _G.ESP.Color
	SelectionBox.Transparency = 0
	SelectionBox.SurfaceTransparency = 1
	SelectionBox.LineThickness = 0.05
	SelectionBox.Parent = Folder
	return SelectionBox
end
local function CreateHighlight(Bodypart)
	local Highlight = Instance.new("Highlight")
	Highlight.Adornee = Bodypart
	Highlight.Name = Bodypart.Name.."-Highlight"
	Highlight.FillColor = _G.ESP.Color
	Highlight.FillTransparency = 0
	Highlight.OutlineTransparency = 1
	Highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	Highlight.Parent = Folder
	return Highlight
end
local function UpdateESPColor(Player, Humanoid)
	local UserId = Player.UserId
	local Cache = _G.ESP.Characters[UserId]
	if not Cache then return end
	local Ratio = Humanoid.Health / Humanoid.MaxHealth
	Ratio = math.clamp(Ratio, 0, 1)
	local Full = _G.ESP.Color
	local Low = Color3.new(1, 0, 0)
	local Color = Color3.new(
		Full.R + (Low.R - Full.R) * (1 - Ratio),
		Full.G + (Low.G - Full.G) * (1 - Ratio),
		Full.B + (Low.B - Full.B) * (1 - Ratio)
	)
	for _, Object in ipairs(Cache) do
		if Object:IsA("SelectionBox") then
			Object.Color3 = Color
			Object.SurfaceColor3 = Color
		elseif Object:IsA("Highlight") then
			Object.FillColor = Color
		elseif Object:IsA("BillboardGui") then
			local NameLabel = Object:FindFirstChild("Name")
			if NameLabel then
				NameLabel.TextColor3 = Color
			end
		end
	end
end
local function CreateNametag(Character, Player)
	local Head = Character:FindFirstChild("Head")
	if not Head then
		return;
	end
	local Tag = Instance.new("BillboardGui")
	Tag.Name = Player.Name.."_Nametag"
	Tag.Adornee = Head
	Tag.Size = UDim2.new(0, 12, 0, 4)
	Tag.StudsOffset = Vector3.new(0, 2.5, 0)
	Tag.AlwaysOnTop = true
	Tag.Parent = Folder
	local Label = Instance.new("TextLabel")
	Label.Size = UDim2.new(1, 0, 1, 0)
	Label.BackgroundTransparency = 1
	Label.Text = Player.Name
	Label.TextColor3 = _G.ESP.Color
	Label.TextStrokeTransparency = 0.5
	Label.TextScaled = true
	Label.Font = Enum.Font.GothamBold
	Label.Parent = Tag
	return Tag
end
local function CreateESP(Player, Character)
	local UserId = Player.UserId
	_G.ESP.Characters[UserId] = _G.ESP.Characters[UserId] or {}
	local Cache = _G.ESP.Characters[UserId]
	if #Cache > 0 then
		for _, v in ipairs(Cache) do
			if v and v.Name then
				local Split = string.split(v.Name, "-")
				local BodypartName = Split[1]
				v.Adornee = Character:FindFirstChild(BodypartName)
				if v:IsA("BillboardGui") then
					v.Adornee = Character:FindFirstChild("Head")
				end
			end
		end
		return
	end
	for _, v in ipairs(Character:GetDescendants()) do
		if v:IsA("Motor6D") and v.Part1 then
			local Bodypart = Character:FindFirstChild(v.Part1.Name)
			if Bodypart then
				table.insert(Cache, CreateSelectionBox(Bodypart))
				table.insert(Cache, CreateHighlight(Bodypart))
			end
		end
	end
	local Nametag = CreateNametag(Character, Player)
	if Nametag then
		table.insert(Cache, Nametag)
	end
end
local function RemoveESP(Player, Permanent)
	local UserId = Player.UserId
	local Cache = _G.ESP.Characters[UserId]
	if not Cache then return end
	for _, v in ipairs(Cache) do
		if v then
			v.Adornee = nil
			if Permanent then
				v:Destroy()
			end
		end
	end
	if Permanent then
		_G.ESP.Characters[UserId] = nil
	end
end
local function SetupPlayer(Player)
	if Player.UserId == Players.LocalPlayer.UserId then return end
	Player.CharacterAdded:Connect(function(Character)
		Character:WaitForChild("Humanoid")
		task.wait()
		CreateESP(Player, Character)
		UpdateESPColor(Player, Character.Humanoid)
		Character.Humanoid.HealthChanged:Connect(function()
			UpdateESPColor(Player, Character.Humanoid)
		end)
	end)
	Player.CharacterRemoving:Connect(function(Character)
		RemoveESP(Player, false)
	end)
	if Player.Character then
		CreateESP(Player, Player.Character)
	end
end
for _, Player in ipairs(Players:GetPlayers()) do
	SetupPlayer(Player)
end
Players.PlayerAdded:Connect(SetupPlayer)
Players.PlayerRemoving:Connect(function(Player)
	RemoveESP(Player, true)
end)
